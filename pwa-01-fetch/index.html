<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#764ba2">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <title>La Terre de la bière</title>


</head>

<body>
  <div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="mb-0">La Terre de la bière</h1>
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBeerModal" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
        <i class="bi bi-plus-circle"></i> Ajouter une bière à la liste
      </button>
    </div>
    <!-- Search Bar -->
    <div class="mb-3">
      <label for="searchInput" class="form-label">Rechercher par nom de bière :</label>
      <input type="text" class="form-control" id="searchInput" placeholder="Entrez le nom de la bière">
    </div>
    <!-- Beer List -->
    <div class="pagination justify-content-center mb-4">
      <nav aria-label="Page navigation example">
        <ul class="pagination" id="pagination">
          <!-- Pagination items will be dynamically added here -->

          <li class="page-item"><a class="page-link" href="#">1</a></li>
          <li class="page-item"><a class="page-link" href="#">2</a></li>
          <li class="page-item"><a class="page-link" href="#">3</a></li>
          <li class="page-item"><a class="page-link" href="#">4</a></li>
          <li class="page-item"><a class="page-link" href="#">5</a></li>
          <li class="page-item"><a class="page-link" href="#">6</a></li>
          <li class="page-item"><a class="page-link" href="#">7</a></li>
          <li class="page-item"><a class="page-link" href="#">8</a></li>
          <li class="page-item"><a class="page-link" href="#">9</a></li>
          <li class="page-item"><a class="page-link" href="#">10</a></li>
        </ul>

    </div>
    <div class="row" id="beerList"></div>
  </div>

  <!-- Modal Ajouter une bière -->
  <div class="modal fade" id="addBeerModal" tabindex="-1" aria-labelledby="addBeerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
          <h5 class="modal-title" id="addBeerModalLabel">Ajouter une bière</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addBeerForm">
            <div class="mb-3">
              <label for="beerName" class="form-label">Nom de la bière *</label>
              <input type="text" class="form-control" id="beerName" required>
            </div>
            <div class="mb-3">
              <label for="beerTagline" class="form-label">Tagline</label>
              <input type="text" class="form-control" id="beerTagline">
            </div>
            <div class="mb-3">
              <label for="beerDescription" class="form-label">Description *</label>
              <input type="text" class="form-control" id="beerDescription" required>
            </div>
            <div class="mb-3">
              <label for="beerAbv" class="form-label"> ABV (%) *</label>
              <input type="number" step="0.1" class="form-control" id="beerAbv" required>
            </div>            
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" id="saveBeerBtn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  <script>
    // Enregistrement du service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('Service Worker enregistré avec succès:', registration.scope);
          })
          .catch(error => {
            console.log('Échec de l\'enregistrement du Service Worker:', error);
          });
      });
    }

    window.addEventListener("load", (event) => {
      var beers = [];
      var currentPage = 1;  
      
      let db;
      const request = indexedDB.open('MaBaseDeDonnees', 1);

      request.onupgradeneeded = event => {
        db = event.target.result;
        
        if (!db.objectStoreNames.contains('beers')) {
          db.createObjectStore('beers', { keyPath: 'id' });
        }
      };

      request.onsuccess = event => {
        db = event.target.result;
        console.log('Base de données ouverte avec succès');
        
        loadBeersFromDB();
      };

      request.onerror = event => {
        console.error('Erreur lors de l\'ouverture de la base de données');
      };

      /**************************
      ***         MODEL
      ***************************/
      // Fonction pour charger depuis IndexedDB
      function loadBeersFromDB() {
        if (!db) {
          modelFetchBeers();
          return;
        }
        const transaction = db.transaction(['beers'], 'readonly');
        const objectStore = transaction.objectStore('beers');
        const requestAll = objectStore.getAll();
        
        requestAll.onsuccess = () => {
          if (requestAll.result.length > 0) {
            beers = requestAll.result;
            console.log('Bières chargées depuis IndexedDB:', beers.length);
            displayBeers(beers);
          } else {
            modelFetchBeers();
          }
        };
        
        requestAll.onerror = () => {
          console.error('Erreur lors du chargement depuis IndexedDB');
          modelFetchBeers();
        };
      }

      // Fonction pour sauvegarder dans IndexedDB
      function saveBeersToDb(beersData) {
        if (!db) return;
        
        const transaction = db.transaction(['beers'], 'readwrite');
        const objectStore = transaction.objectStore('beers');
        
        beersData.forEach(beer => {
          const ajoutRequete = objectStore.add({ id: beer.id, nom: beer.name, ...beer });
          
          ajoutRequete.onsuccess = () => {
            console.log('Bière ajoutée avec succès:', beer.name);
          };
          
          ajoutRequete.onerror = (e) => {
            console.error('Erreur lors de l\'ajout de la bière:', beer.name);
          };
        });
      }

      // Function to fetch beers from Punk API
      async function modelFetchBeers(page = 1) {
        currentPage = page;
        console.log("Fetching beers for page:", page, currentPage);
        try {
          const response = await fetch(`https://punkapi.online/v3/beers?page=${page}`);
          const data = await response.json();
          beers = Array.isArray(data) ? data : (data.beers || []);
          console.log("Beers loaded:", beers.length);
          
          // Sauvegarder dans IndexedDB
          saveBeersToDb(beers);
          
          displayBeers(beers);

        } catch (error) {
          console.error('Error fetching beers:', error);
          beers = [];
          displayBeers(beers);
        }
      }
      /**************************
        ***         VIEW
        ***************************/
      // function ECMA 6 represent the view template
        var template = (beer) => `
            <div class="col-md-4 mb-4">
              <div class="card h-100">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px 10px 0 0;">
                  <img src="${beer.image ? 'https://punkapi.online/v3/images/' + beer.image : (beer.image_url || 'https://via.placeholder.com/150')}" class="card-img-top" style="height:250px;object-fit:contain;filter:drop-shadow(0 4px 8px rgba(0,0,0,0.3))" alt="${beer.name}">
                </div>
                <div class="card-body d-flex flex-column" style="background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);">
                  <h5 class="card-title" style="color: #764ba2; font-weight: bold;">${beer.name}</h5>
                  <p class="card-text" style="flex:1; color: #495057;">${beer.description}</p>
                  <p class="mb-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 12px; border-radius: 5px; display: inline-block;"><strong>ABV:</strong> ${beer.abv ? beer.abv + '%' : 'N/A'}</p>
                </div>
              </div>
            </div>
          `;
      /**************************
      ***         CONTROLLER
      ***************************/
      // Function to display beers on the page
      function displayBeers(beersToShow) {
        const beerList = document.getElementById('beerList');
        beerList.innerHTML = '';
        if (!beersToShow || beersToShow.length === 0) {
          beerList.innerHTML = '<div class="col-12"><p>Aucune bière trouvée.</p></div>';
          return beersToShow;
        }
        beersToShow.forEach(beer => {
          beerList.innerHTML += template(beer);
        });
        return beersToShow;
      }
      // Function to filter beers based on search input
      function filterBeers() {
        const searchInput = document.getElementById('searchInput').value.toLowerCase();
        if (!beers || beers.length === 0) {
          displayBeers([]);
          return;
        }
        const filteredBeers = beers.filter(beer => 
          (beer.name || '').toLowerCase().includes(searchInput) ||
          (beer.description || '').toLowerCase().includes(searchInput) ||
          (beer.tagline || '').toLowerCase().includes(searchInput) 

        );
        displayBeers(filteredBeers);
      }
      // Event listener for search input
      document.getElementById('searchInput').addEventListener('input', filterBeers);
      
      // Fonction pour ajouter une nouvelle bière
      function addNewBeer() {
        const name = document.getElementById('beerName').value;
        const tagline = document.getElementById('beerTagline').value;
        const description = document.getElementById('beerDescription').value;
        const abv = parseFloat(document.getElementById('beerAbv').value);
        
        
        if (!name || !description || !abv) {
          alert('Veuillez remplir tous les champs obligatoires');
          return;
        }
        
        const newBeer = {
          id: Date.now(),
          name: name,
          tagline: tagline,
          description: description,
          abv: abv,
          
        };
        
        // Ajouter à IndexedDB
        if (db) {
          const transaction = db.transaction(['beers'], 'readwrite');
          const objectStore = transaction.objectStore('beers');
          const ajoutRequete = objectStore.add(newBeer);
          
          ajoutRequete.onsuccess = () => {
            console.log('Nouvelle bière ajoutée avec succès:', newBeer.name);
            beers.push(newBeer);
            displayBeers(beers);
            
            // Fermer le modal et réinitialiser le formulaire
            const modal = bootstrap.Modal.getInstance(document.getElementById('addBeerModal'));
            modal.hide();
            document.getElementById('addBeerForm').reset();
          };
          
          ajoutRequete.onerror = () => {
            alert('Erreur lors de l\'ajout de la bière');
          };
        }
      }
      
      // Event listener pour le bouton Enregistrer
      document.getElementById('saveBeerBtn').addEventListener('click', addNewBeer);
      // Add control if needed and then call the model
      modelFetchBeers();

      // add event listeners for pagination
      const elements = document.getElementsByClassName("page-link");

      // Convert the HTMLCollection to an array to avoid live collection issues
      Array.from(elements).forEach((el, index) => {
        el.addEventListener("click", (event) => {
          event.preventDefault();
         // let page;
          const urlParams = new URLSearchParams(window.location.search);
          let page = currentPage;
          console.log(el.textContent);
          if (el.text === "Previous") {
            page -= 1;
          } else if (el.textContent === "Next") {
            page += 1;
          } else {
            page = parseInt(el.text);
          }
          modelFetchBeers(page);
          // Update active class
          document.querySelectorAll(".page-item").forEach(item => item.classList.remove("active"));
          if (el.text !== "Previous" && el.text !== "Next") {
            el.parentElement.classList.add("active");
          } else {
            document.querySelector(`.page-item:nth-child(${page + 1})`).classList.add("active");
          }
        });
      });

    });
  </script>
</body>

</html>